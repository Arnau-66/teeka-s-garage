<section class="starships-list hangar">
  <div class="hangar__bg" aria-hidden="true"></div>
  <div class="hangar__stars" aria-hidden="true"></div>

  <div class="hangar__panel">

    <div class="back-orbit">
      <a routerLink="/" class="sw-btn orbit-button" aria-label="Back to Orbit">
        <span class="sw-btn__inner">
          <span class="sw-btn__icon" aria-hidden="true">⟵</span>
          <span class="sw-btn__label">Back to Orbit</span>
        </span>
      </a>

      @if (starships().length) {
        @let ship = starships()[activeIndex()];

        <a class="sw-btn details-button"
          [routerLink]="['/starships', idFromUrl(ship?.url ?? '')]"
          [attr.aria-label]="'View details for ' + (ship?.name ?? 'starship')">
          <span class="sw-btn__inner">
            <span class="sw-btn__label">View Details</span>
          </span>
        </a>
      }

    </div>

    @if (loading()) {
      <p aria-live="polite">Loading starships...</p>
    }
    @else if (error()) {
      <div class="error" role="alert" aria-live="assertive">
        <p>Ooops! {{ error() }} </p>
        <button type="button" class="sw-btn" (click)="fetchPage(1)">
          <span class="sw-btn__inner"><span class="sw-btn__label">Retry</span></span>
        </button>
      </div>
    }
    @else {

      <!-- HOLOGRAMA CENTRAL (POR DELANTE DEL PROYECTOR) -->
      <div class="holo-stage" aria-hidden="true">
        @if (starships().length) {
          @let ship = starships()[activeIndex()];

          <img
            [src]="shipImageFrom(ship)"
            [attr.alt]="(ship?.name ?? 'Starship') + ' hologram'"
            (error)="onImgError($event)"
          />

          <div class="holo-caption aurebesh">
            {{ ship?.name ?? '—' }}
          </div>
        }

      </div>

      <!-- CONTROLES DEL CARRUSEL (sin lista visible) -->
      <div class="carousel" role="region" aria-roledescription="carousel" aria-label="Starships carousel">
        <button class="car-btn sw-btn car-btn--prev"
                type="button"
                (click)="goPrevInCarousel()"
                [disabled]="activeIndex() === 0"
                aria-label="Previous">
          <span class="sw-btn__inner"><span class="sw-btn__icon">‹</span></span>
        </button>

        <!-- Lista funcional (oculta visualmente, mantiene a11y y lógica) -->
        <ul #rack class="starships rack is-hidden"
            role="listbox"
            [attr.aria-activedescendant]="'ship-' + activeIndex()">
          @for (ship of starships(); track ship.url; let i = $index) {
            <li class="ship-item"
                [attr.data-idx]="i"
                [class.is-active]="i === activeIndex()"
                [id]="'ship-' + i"
                role="option"
                [attr.aria-selected]="i === activeIndex()"
                [attr.aria-current]="i === activeIndex() ? 'true' : null"
                tabindex="-1">
              <span class="sr-only">{{ ship.name }}</span>
            </li>
          } @empty {
            <li class="empty">No starships found.</li>
          }
        </ul>

        <button class="car-btn sw-btn car-btn--next"
                type="button"
                (click)="goNextInCarousel()"
                [disabled]="activeIndex() >= starships().length - 1"
                aria-label="Next">
          <span class="sw-btn__inner"><span class="sw-btn__icon">›</span></span>
        </button>
      </div>

      <div class="pager bottom">
        <button type="button"
                class="sw-btn pager__prev"
                (click)="prevPage()
                "
                [disabled]="!hasPrev() || loading()">
          <span class="sw-btn__inner"><span class="sw-btn__label">Prev Page</span></span>
        </button>

        <button type="button"
                class="sw-btn pager__next"
                (click)="nextPage()"
                [disabled]="!hasNext() || loading()">
          <span class="sw-btn__inner"><span class="sw-btn__label">More Starships</span></span>
        </button>
      </div>
    }
  </div>

  <!-- HOLOPROYECTOR (queda por detrás) -->
  <div class="holoprojector" aria-hidden="true">
    <img class="holoprojector__img" src="/img/ui/holoprojector.png" alt="">
    <div class="holoprojector__beam"></div>
  </div>

  <!-- ===== FX SVG: filtros para interferencias / grano / scanlines ===== -->
  <svg aria-hidden="true" width="0" height="0" style="position:absolute">
    <defs>
      <!-- Holo FX: grano + ligera distorsión + parpadeo -->
      <filter id="holoFX">
        <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="8" result="noise">
          <animate attributeName="baseFrequency" values="0.85;0.95;0.9;0.87;0.92" dur="2.2s" repeatCount="indefinite"/>
          <animate attributeName="seed" values="1;3;5;7;9;11;13;15" dur="1.6s" repeatCount="indefinite"/>
        </feTurbulence>
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="2.2" xChannelSelector="R" yChannelSelector="G" result="displaced"/>
        <feColorMatrix in="noise" type="saturate" values="0" result="mono"/>
        <feComponentTransfer in="mono" result="grain">
          <feFuncA type="table" tableValues="0 0.45 0"/>
        </feComponentTransfer>
        <feBlend mode="screen" in="displaced" in2="grain"/>
      </filter>

      <!-- Scanlines horizontales -->
      <filter id="scanlines">
        <feImage
          preserveAspectRatio="none"
          x="0" y="0" width="100%" height="100%"
          href="data:image/svg+xml;utf8,
            <svg xmlns='http://www.w3.org/2000/svg' width='4' height='4'>
              <rect width='4' height='2' fill='black' />
              <rect y='2' width='4' height='2' fill='white' />
            </svg>"
          result="lines"/>
        <feComposite operator="in" in="SourceGraphic" in2="lines"/>
      </filter>
    </defs>
  </svg>
</section>
